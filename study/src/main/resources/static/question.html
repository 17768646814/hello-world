<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<!--<script src="//cdn.bootcss.com/highcharts/5.0.6/highcharts.js"></script>-->
<script src="//cdn.bootcss.com/highcharts/5.0.6/highstock.js"></script>
<script src="//cdn.bootcss.com/highcharts/5.0.6/modules/exporting.js"></script>
<!--<script src="//cdn.bootcss.com/highcharts/5.0.6/js/themes/dark-unica.js"></script>-->

<div class="container">
    <div class="row">
        <div id="rate" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
        <div class="text-center" id="btn-group">
            <button class="btn btn-default" data-month="3">近3个月</button>
            <button class="btn btn-default" data-month="6">近6个月</button>
            <button class="btn btn-default" data-month="12">近1年</button>
            <button class="btn btn-default" data-month="36">近3年</button>
        </div>
    </div>
    <div class="row">
        <div id="container" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
    </div>
</div>

<script type="text/javascript">
    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i"), r = window.location.search.substr(1).match(reg);
        return r != null ? decodeURIComponent(r[2]) : r;
    }
    function getDate10(date) {
        var y = String(date.getFullYear()), m = String(date.getMonth() + 1), d = String(date.getDate());
        m = m.length == 1 ? '0' + m : m;
        d = d.length == 1 ? '0' + d : d;
        return y + '-' + m + '-' + d;
    }
    function getMonthBefore(date, month) {
        var y = date.getFullYear(), m = date.getMonth(), d = date.getDate(), month = Number(month);
        while ((m -= month) < 0) m += 12 * (y - --y) + month;
        return new Date(y, m, d);
    }
    function str10ToDate(str) {
        return Date.UTC(str.substr(0, 4), str.substr(5, 2) - 1, str.substr(8, 2));
    }
    var fund = null, chart = null, rateChart = null, data = {
                'fundCode': getQueryString("fundCode"),
                'bdate': getDate10(getMonthBefore(new Date(), 12 * 3)),
                'edate': getDate10(new Date())
            }, dateFormart = {
                millisecond: '%H:%M:%S.%L',
                second: '%H:%M:%S',
                minute: '%H:%M',
                hour: '%H:%M',
                day: '%Y-%m-%d',
                week: '%Y-%m-%d',
                month: '%Y-%m',
                year: '%Y'
            },
            opt = {
                title: {
                    text: '基金收益率'
                },
                tooltip: {
                    dateTimeLabelFormats: dateFormart,
                    valueSuffix: '%'
                },
                'series': [
                    {
                        'name': '净值增长率',
                        'type': 'area',
                        'data': []
                    }
                ],
                credits: {
                    enabled: false
                },
                xAxis: {
                    type: 'datetime',
                    dateTimeLabelFormats: dateFormart
                },
                yAxis: {
                    title: {
                        text: ''
                    },
                    labels: {
                        formatter: function () {
                            return this.value + '%';
                        }
                    }
                },
                legend: {
                    layout: 'vertical',
                    align: 'right',
                    verticalAlign: 'middle',
                    borderWidth: 0
                }
            }, opt1 = {
                chart: {
                    zoomType: 'x'
                },
                title: {
                    text: '基金历史数据'
                },
                rangeSelector: {
                    allButtonsEnabled: true,
                    buttonSpacing: 35,
                    buttons: [{
                        type: 'month',
                        count: 3,
                        text: '近3个月'
                    }, {
                        type: 'month',
                        count: 6,
                        text: '近6个月'
                    }, {
                        type: 'year',
                        count: 1,
                        text: '近1年'
                    }, {
                        type: 'year',
                        count: 3,
                        text: '近3年'
                    }],
                    selected: 0,
                    inputEnabled: false
                },
                series: [
                    {
                        'name': '单位净值',
                        'type': 'area',
                        'data': []
                    }, {
                        'name': '累计净值',
                        'type': 'area',
                        'data': []
                    }
                ],
                tooltip: {
                    dateTimeLabelFormats: {
                        millisecond: '%H:%M:%S.%L',
                        second: '%H:%M:%S',
                        minute: '%H:%M',
                        hour: '%H:%M',
                        day: '%Y-%m-%d',
                        week: '%Y-%m-%d',
                        month: '%Y-%m',
                        year: '%Y'
                    }
                },
                navigator: {
                    xAxis: {
                        labels: {
                            format: '{value:%Y-%m-%d}'
                        }
                    }
                },
                credits: {
                    enabled: false
                },
                xAxis: {
                    type: 'datetime',
                    dateTimeLabelFormats: dateFormart
                },
                tooltip: {
                    dateTimeLabelFormats: dateFormart
                },
                yAxis: {
                    title: {
                        text: ''
                    }
                },
                legend: {
                    layout: 'vertical',
                    align: 'right',
                    verticalAlign: 'middle',
                    borderWidth: 0
                },
                plotOptions: {
                    area: {
                        pointStart: 1940,
                        marker: {
                            lineWidth: 1,
                            lineColor: '#666666',
                            symbol: 'circle',
                            radius: 2,
                            states: {
                                hover: {
                                    enabled: true
                                }
                            }
                        },
                        stacking: 'normal',
                        lineColor: '#666666',
                        lineWidth: 1
                    }
                }
            },
            $btns = $('div#btn-group button');
    $btns.click(function () {
        $btns.removeClass('active');
        var month = $(this).addClass('active').attr('data-month');
        setData(month);
    });
    function initChart() {
        rateChart = Highcharts.chart('rate', opt);
        chart = Highcharts.stockChart('container', opt1);
    }
    function load(data) {
        $.ajax({
            'url': 'http://localhost:8066/web/fund/query/queryNav',
            'dataType': 'jsonp',
            'data': data
        }).success(function (obj) {
            fund = obj.items;
            var arr = [], arr1 = [];
            for (var i = 0; i < fund.length; i++) {
                var f = fund[i], d10 = str10ToDate(f.PublishDate);
                arr.push([d10, f.nav1]);
                arr1.push([d10, f.nav2]);
            }
            chart.series[0].setData(arr);
            chart.series[1].setData(arr1);
            $($btns[0]).click()
        });
    }
    function setData(month) {
        var start = getDate10(getMonthBefore(new Date(), month))/*, arr = [], arr1 = []*/, rateArr = [], findFirst =
                false, first = 0;
        for (var i = 0; i < fund.length; i++) {
            var f = fund[i];
            if (start <= f.PublishDate.substr(0, 10)) {
                var d10 = str10ToDate(f.PublishDate);
                /*arr.push([d10, f.nav1]);
                 arr1.push([d10, f.nav2]);*/
                if (!findFirst) {
                    first = f.nav2;
                    findFirst = true;
                    rateArr.push([d10, 0]);
                } else {
                    rateArr.push([d10, Math.round((f.nav2 / first - 1) * 10000) / 100]);
                }
            }
        }
//        chart.series[0].setData(arr);
//        chart.series[1].setData(arr1);
        rateChart.series[0].setData(rateArr);
    }
    $(function () {
        initChart();
        load(data);
    });

</script>
</body>
</html>